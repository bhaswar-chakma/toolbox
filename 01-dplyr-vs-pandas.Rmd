# dplyr vs pandas & numpy

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r lib-r, echo = FALSE}
library(dplyr)
```

```{python lib-py, echo = FALSE}
import pandas as pd
import numpy as np
```



We will use the five [dplyr verbs](https://dplyr.tidyverse.org/) (also [pandas' guide](https://pandas.pydata.org/pandas-docs/stable/getting_started/comparison/comparison_with_r.html)) for comparison

- `select()` picks variables based on their names.


- `mutate()` adds new variables that are functions of existing variables


- `filter()` picks cases based on their values.

- `summarise()` reduces multiple values down to a single summary.

- `arrange()` changes the ordering of the rows.


and use the following toy data to apply the verbs.



```{r df0-r, include = FALSE}
df <- tibble(
  name = c("Barney", "Ted", "Marshall",
           "Lilly","Robin"),
  gender = c("Male", "Male","Male",
             "Female", "Female"),
  grade = c(10, 11, 13, 12, 14)
)
df
```

```{r, echo = FALSE}
knitr::kable(df)
```

<span style="color:blue">**Create Toy Data**</span>


<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>
```{r df-r}
df <- tibble(
  name = c("Barney", "Ted", "Marshall",
           "Lilly","Robin"),
  gender = c("Male", "Male","Male",
             "Female", "Female"),
  grade = c(10, 11, 13, 12, 14)
)
df
```

</td>
<td>
```{python df-py}
df = pd.DataFrame({
  'name':["Barney", "Ted", "Marshall",
          "Lilly", "Robin"],
  'gender':["Male", "Male","Male", 
            "Female", "Female"],
  'grade':[10, 11, 13, 12, 14] 
})
df
```
</td>
<tr>
</table>



<span style="color:blue">**Check Data Structure**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r glimpse-r}
glimpse(df)
```
</td>
<td>
```{python dtypes-py}
df.dtypes
df.shape
df.info()
```
</td>
<tr>
</table>



## `select()`

<span style="color:blue">**Task: Pick the variables `name` and `grade`.
**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r select-r}
df %>% 
  select(name, grade)

```

</td>
<td>
```{python select-py}
df[['name', 'grade']]

```

```{python}
# or
df.drop(columns = ['gender'])
```

```{python}
# or
df.drop(['gender'], axis = 1)
```

</td>
<tr>
</table>

## `mutate()`

<span style="color:blue">**Task: Generate a variable `grade_p`, expressing grade out of 100.
**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r mutate-r}
df %>% 
  mutate(grade_p = grade/20*100)

```

</td>
<td>
```{python mutate-py}
df['grade_p'] = df['grade']/20*100
df
```
```{python}
# now drop the newly created variable
df.drop(columns = 'grade_p', inplace = True)
```

</td>
<tr>
</table>

## `filter()`

<span style="color:blue">**Task: Keep Barney or females.
**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r filter-r}
df %>% 
  filter(name == "Barney"|
         gender == "Female")

```

</td>
<td>
```{python filter-py}
# similar to base R
df[(df["name"] == "Barney") | 
   (df["gender"] == "Female")]
```

```{python filter2-py}
# query with ''; need to use "" for conditions
df.query('name == "Barney"|gender == "Female"')
```

```{python filter3-py}
# query with ""; need to use '' for conditions
df.query("name == 'Barney'| gender == 'Female'")
```

</td>
<tr>
</table>




## `group_by()` and `summarize()`

<span style="color:blue">**Task: Grouped by gender, find mean grade.
**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r grp-sum1-r}
df %>% 
  group_by(gender) %>% 
  summarize(avg_grade = mean(grade))

```

</td>
<td>
```{python grp-sum1a-py}
# returns a series
df.groupby("gender")['grade'].mean()
```

```{python grp-sum1b-py}
# returns a data frame
df[['gender', 'grade']].groupby("gender").mean()
```
</td>
<tr>
</table>



<span style="color:blue">**Task: Grouped by gender, find mean, median, minimum, and maximum grade.
**</span>


<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>


```{r grp-sum2-r}
df %>% 
  group_by(gender) %>% 
  summarize(mean = mean(grade),
            median = median(grade),
            min = min(grade),
            max = max(grade))

```

</td>
<td>
```{python grp-sum2-py}
df.groupby("gender")['grade'].agg(
  # provide a dictionary
  {# variable name followed by function
    'mean': 'mean',
    'median': 'median',
    'min': 'min',
    'max': 'max'
  }
)
```


</td>
<tr>
</table>


## `arrange()`

<span style="color:blue">**Task: Arrange grade in ascending order.
**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r arrange-a-r}
df %>% 
  arrange(grade)
```

</td>
<td>
```{python arrange-a-py}
df.sort_values('grade')
```

</td>
<tr>
</table>

<span style="color:blue">**Task: Arrange grade in ascending order.
**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r arrange-desc-r}
df %>% arrange(desc(grade))
```

</td>
<td>
```{python arrange-desc-py}
df.sort_values('grade', ascending = False)
```

</td>
<tr>
</table>

<span style="color:blue">**Task: Arrange gender in ascending order then arrange grade in descending order.
**</span>

<table class='table'>
<tr> <th>dplyr</th> <th>pandas</th> <tr>
<tr>
<td>

```{r arrange-multiple-r}
df %>%
  arrange(gender, desc(grade))
```

</td>
<td>
```{python arrange-multiple-py}
df.sort_values(['gender','grade'],
                ascending = [True, False])
```
</td>
<tr>
</table>

## Helper Functions

### `case_when()` vs `pd.cut()` vs `np.select()`

<span style="color:blue">*Suppose we have a data frame with a variable called `age`. We want to create a variable `age_cat` with the following conditions:*

  -  `age` < 18: "Kids"
  
  -  18 $\leq$ `age` < 31: "18-30"
  
  -  31 $\leq$ `age`: "31 and above"</span>

With `dplyr::case_when()` we can do it in the following way:

```{r}
# example data
df <- tibble(age = c(9, 10, 18, 21, 29, 31, 45))
# case_when() in action
df %>% 
  mutate(age_cat = case_when(
    age < 18 ~ "Kids",
    age >= 18 & age < 31 ~ "18-30",
    age >= 31 ~ "31 and above"
  ))
```

We can achieve the same result in Python using 

  - `np.select()`
  
  - `pd.cut()`

```{python}
df = pd.DataFrame({'age': [9, 10, 18, 21, 29, 31, 45]})
```


<table class='table'>
<tr> <th>numpy</th> <th>pandas</th> <tr>
<tr>
<td>

```{python}
# Step 1: Create conditions
conditions = [
  (df['age'].lt(18)),
  (df['age'].ge(18) & (df['age'].lt(31))),
  (df['age'].ge(31))
]
# Step 2: Assign names based on the conditions
cat_names = ['Kids', '18-30', '30 and above']

# Step 3: Use np.select() to generate the variable
df['age_cat'] = np.select(conditions, cat_names)
df
```

</td>
<td>
```{python}
# Step 1: Create bin condition
bin_cond = [0, 17, 30, np.inf] 
# note: instead of 0, 
#    -np.inf will also work

# Step 2: Assign bin labs
bin_lab = ['Kids', '18-30',
           '30 and above']

# Step 3: Use pd.cut() 
df["age_cat"] = pd.cut(df["age"],
                       bins=bin_cond,
                       labels=bin_lab)
df
```
</td>
<tr>
</table>

### `if_else()` vs `np.where()`

<span style="color:blue"> *Given prices of shirts `price`, how do we create a variable `price_cat` with the following conditions?*

  - when `price` is less than 50, we label it as "Cheap"
  
  - when `price` is 50 or more, we label it as "Expensive"</span>


<table class='table'>
<tr> <th>dplyr</th> <th>numpy</th> <tr>
<tr>
<td>

```{R}
# toy data
prices <- c(25, 30, 45, 80,100, 125)
df <- tibble(price = prices)
# case_when in action
df %>% 
  mutate(price_cat = if_else(
    price <50, "Cheap", "Expenseive"
  ))
```

</td>
<td>
```{python}
# toy data
prices = {'price': [25, 30, 45, 80,100, 125]}
df = pd.DataFrame(prices)
# np.where() in action
df['price_cat'] = np.where(
  df.price < 50, "Cheap", "Expenseive"
)
df
```
</td>
<tr>
</table>


